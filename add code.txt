# add at the end in server.py

@mcp.tool()
async def convert_utc_to_local_time(utc_time_str: str, timezone_str: str = "Asia/Kolkata") -> str:
    """
    Convert a UTC datetime string to local time by adding +5 hours 30 minutes (IST offset).

    Args:
        utc_time_str: UTC datetime string in format 'YYYY-MM-DD HH:MM' or ISO 'YYYY-MM-DDTHH:MM:SS'
        timezone_str: Optional, defaults to 'Asia/Kolkata'

    Returns:
        JSON string with both UTC and manually converted local time.
    """
    try:
        from datetime import datetime, timedelta
        import json

        # --- Parse the UTC time safely ---
        try:
            if "T" in utc_time_str:
                utc_dt = datetime.fromisoformat(utc_time_str)
            else:
                utc_dt = datetime.strptime(utc_time_str, "%Y-%m-%d %H:%M")
        except Exception:
            return json.dumps({
                "ok": False,
                "error": {"message": "Invalid UTC time format. Expected 'YYYY-MM-DD HH:MM' or ISO format."}
            })

        # --- Manually add +5 hours 30 minutes ---
        local_dt = utc_dt + timedelta(hours=5, minutes=30)

        # --- Return valid JSON output ---
        return json.dumps({
            "ok": True,
            "data": {
                "utc_time": utc_dt.strftime("%Y-%m-%d %H:%M"),
                "local_time": local_dt.strftime("%Y-%m-%d %H:%M"),
                "offset_applied": "+05:30",
                "timezone": timezone_str
            }
        })

    except Exception as e:
        return json.dumps({
            "ok": False,
            "error": {"message": str(e)}
        })











# add in prompt client.py




SYSTEM_PROMPT_PLAN = f"""
You are an assistant that converts user questions into MCP tool calls.
Use only these tools exactly as defined below:

{_build_tool_prompt()}

Rules:
1. Output only valid JSON.
2. Always return a top-level key 'plan' as a list.
3. If the user asks about current time or converting UTC to local time,
   use the tool "convert_utc_to_local_time" with arguments:
   - utc_time_str: (UTC datetime string, e.g. "2024-06-23 13:25")
   - timezone_str: (e.g. "Asia/Kolkata", "America/New_York")
   Note: The conversion adds +5 hours and 30 minutes (IST offset) to the UTC time by default.
4. For flight info, use get_flight_basic_info or get_delay_summary.
5. Do not invent tool names.
6. If carrier or date not mentioned, omit them instead of writing 'unknown'.
7. Only use "tool" as key, not "name".
"""

SYSTEM_PROMPT_SUMMARIZE = """
You are an assistant that summarizes tool outputs into a concise and user-friendly answer.
When summarizing time conversions, clearly mention the UTC time, the +5:30 hour offset applied,
and the resulting local (IST) time. Focus on clarity and readability.
"""

# add at the end in client.py


async def test_convert_time():
    """
    Test converting a UTC time to local time by first adding 5 hours 30 minutes
    (to simulate manual conversion to IST), then verifying via the MCP tool.
    """
    client = FlightOpsMCPClient()
    await client.connect()

    # Original UTC time
    utc_time_str = "2024-06-23 13:25"
    utc_dt = datetime.strptime(utc_time_str, "%Y-%m-%d %H:%M")

    # Add 5 hours 30 minutes ‚Üí simulate conversion to IST (Asia/Kolkata)
    local_dt = utc_dt + timedelta(hours=5, minutes=30)
    local_time_str = local_dt.strftime("%Y-%m-%d %H:%M")

    print(f"üïê Original UTC Time: {utc_time_str}")
    print(f"üáÆüá≥ Simulated Local Time (+5:30): {local_time_str}")

    # Call MCP tool to validate conversion
    args = {
        "utc_time_str": utc_time_str,
        "timezone_str": "Asia/Kolkata"
    }

    print("\nüöÄ Invoking convert_utc_to_local_time tool...\n")
    result = await client.invoke_tool("convert_utc_to_local_time", args)

    print("‚úÖ Tool Response:")
    print(json.dumps(result, indent=2))

    await client.disconnect()




# add in tool_regisry.py



"convert_utc_to_local_time": {
    "args": ["utc_time_str", "timezone_str"],
    "desc": "Convert a UTC datetime string (utc_time_str) to local time by adding +5 hours 30 minutes (IST offset). The timezone_str is optional and defaults to 'Asia/Kolkata'.",
},